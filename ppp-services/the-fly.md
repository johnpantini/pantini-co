# –ü–∞—Ä—Å–µ—Ä The Fly

{% hint style="danger" %}
–ú–∞—Ç–µ—Ä–∏–∞–ª –ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞–µ—Ç, —á—Ç–æ –≤—ã [—É—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ppp](../ppp/getting-started.md) –∏ –Ω–∞—Å—Ç—Ä–æ–∏–ª–∏ –µ–≥–æ (–≤–≤–µ–ª–∏ –≤—Å–µ –∫–ª—é—á–∏ –æ–±–ª–∞—á–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤).
{% endhint %}

–í –º–∞—Ç–µ—Ä–∏–∞–ª–µ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä—Å–µ—Ä–∞ –Ω–æ–≤–æ—Å—Ç–µ–π —Å —Ä–µ—Å—É—Ä—Å–∞ [https://thefly.com/news.php](https://thefly.com/news.php)

–í –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ ppp –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª **–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–∏—Å** –∏–∑ –±–æ–∫–æ–≤–æ–≥–æ –º–µ–Ω—é, –∑–∞—Ç–µ–º –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç **–ü–∞—Ä—Å–µ—Ä —Å –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å—é**. –î–∞–ª–µ–µ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç—Å—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π –ø–æ –ø–æ—Ä—è–¥–∫—É –∏—Ö —Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –≤ —Ñ–æ—Ä–º–µ.

**–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞** –≤–ø–∏—à–∏—Ç–µ –ª—é–±–æ–µ –ø–æ –∂–µ–ª–∞–Ω–∏—é, –Ω–∞–ø—Ä–∏–º–µ—Ä, The Fly SPBEX (–≤ –ø—Ä–∏–º–µ—Ä–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ç–∏–∫–µ—Ä—ã –°–ü–ë –ë–∏—Ä–∂–∏).

**–ü—Ä–æ—Ñ–∏–ª—å API Supabase** –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å [—Å–æ–∑–¥–∞–Ω –∑–∞—Ä–∞–Ω–µ–µ](../recipes/supabase.md). –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à—É –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Å–ø–∏—Å–∫–∞.

–í –ø–æ–ª–µ **–†–µ—Å—É—Ä—Å** –≤—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç [`https://thefly.com/news.php`](https://thefly.com/news.php)``

–ü–æ–ª–µ **–§—Ä–µ–π–º** –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º.

**–ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–ø—Ä–æ—Å–∞** –∑–∞–¥–∞–π—Ç–µ –ø–æ –∂–µ–ª–∞–Ω–∏—é –æ—Ç 1 –¥–æ 5 —Å–µ–∫—É–Ω–¥.

**–ì–ª—É–±–∏–Ω–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è** - 50.

**–ü–æ–ª—è —Ç–∞–±–ª–∏—Ü—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è** - –≤—Å—Ç–∞–≤—å—Ç–µ —Ç–∞–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ:

```sql
title text primary key,
tickers text,
topic text,
date text not null,
priority bool not null,
link text
```

**–°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ** - –∑–¥–µ—Å—å –º—ã —Å—Ñ–æ—Ä–º–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ —Ç–∏–∫–µ—Ä–æ–≤ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è. –î–ª—è –ø—Ä–∏–º–µ—Ä–∞ –≤–æ–∑—å–º–µ–º —Ç–∏–∫–µ—Ä—ã –¥–æ–ª–ª–∞—Ä–æ–≤—ã—Ö –±—É–º–∞–≥ –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ –æ–¥–Ω–æ–≥–æ –∏–∑ –∫—Ä—É–ø–Ω—ã—Ö —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –±—Ä–æ–∫–µ—Ä–æ–≤:

```javascript
const instruments =
  JSON.parse(
    plv8.execute(
      `select content from http_get('https://api.tinkoff.ru/trading/stocks/list?sortType=ByName&orderType=Asc&country=All')`
    )[0].content
  ).payload.values || [];

const symbols = [];

for (const i of instruments) {
  if (i.symbol.currency === 'USD' && i.symbol.ticker !== 'TCS')
    symbols.push(i.symbol.ticker.replace('.', ' '));
}

symbols.push('$ECON');
symbols.push('SPY');
symbols.push('SPB');
symbols.push('CIAN');
symbols.push('OZON');
symbols.push('QIWI');
symbols.push('MTL');

return symbols;
```

**–§—É–Ω–∫—Ü–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞** –∏–º–µ–µ—Ç —Ç–∞–∫–æ–π –∫–æ–¥:

```javascript
const isDST = () => {
  const currentDate = new Date();
  const currentYear = currentDate.getFullYear();
  const firstOfMarch = new Date(currentYear, 2, 1);
  const daysUntilFirstSundayInMarch = (7 - firstOfMarch.getDay()) % 7;
  const secondSundayInMarch =
    firstOfMarch.getDate() + daysUntilFirstSundayInMarch + 7;
  const start = new Date(currentYear, 2, secondSundayInMarch);
  const firstOfNovember = new Date(currentYear, 10, 1);
  const daysUntilFirstSundayInNov = (7 - firstOfNovember.getDay()) % 7;
  const firstSundayInNovember =
    firstOfNovember.getDate() + daysUntilFirstSundayInNov;
  const end = new Date(currentYear, 10, firstSundayInNovember);

  return (
    currentDate.getTime() <= end.getTime() &&
    currentDate.getTime() >= start.getTime()
  );
};

const stories = [];
const fetch = plv8.find_function('ppp_fetch');
const html = fetch('[%#payload.url%]', {
  headers: {
    'User-Agent': '[%#navigator.userAgent%]'
  }
}).responseText;

for (const m of html.matchAll(
  /(<tr id="news_[\s\S]+?)<div class='newsContent'>/gi
)) {
  const story = m[1];
  const priority = /tr_noticia_prioridad/i.test(story);
  const [_, topic, link, title] = story
    .replace('<span class="importantHeadline">', '')
    .match(
      /data-topic="(.+?)"[\s\S]+<a[\s\S]+href='([\s\S]+?)'><span>([\s\S]+?)<\/span>/i
    );
  const [__, time, date] = story.match(
    /soloHora">([\s\S]+?)<div class="fpo_overlay_ticker">([\s\S]+?)<\/div>/i
  );

  const tickers = [...story.matchAll(/data-ticker='([\s\S]+?)'/gi)].map(
    (i) => i[1]
  );

  if (tickers.some((t) => consts.indexOf(t) > -1))
    stories.push({
      date: `${date} ${time} GMT-${isDST() ? '7' : '8'}`,
      tickers: tickers.join(','),
      priority,
      topic,
      link,
      title: title.replace(/&#039;/g, "'").replace(/&amp;#39;/g, "'")
    });
}

return stories;
```

–î–∞–ª–µ–µ –∏–¥—ë—Ç —Å–µ–∫—Ü–∏—è —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ - –æ—Å—Ç–∞–≤–ª—è–µ–º –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π. –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —Å–µ–∫—Ü–∏—é **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram**, –≤–∫–ª—é—á–∞–µ–º —Ñ–ª–∞–∂–æ–∫ **–¢–∞–∫–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram**. &#x20;

**–ë–æ—Ç** –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω –≤ **ppp** –≤ —Ä–∞–∑–¥–µ–ª–µ **–ë–æ—Ç—ã Telegram**. –ß—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –±–æ—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É `/newbot` –±–æ—Ç—É [https://telegram.me/BotFather](https://telegram.me/BotFather)

–í –ø–æ–ª–µ **–ö–∞–Ω–∞–ª –∏–ª–∏ –≥—Ä—É–ø–ø–∞** –≤–≤–µ–¥–∏—Ç–µ ID –∫–∞–Ω–∞–ª–∞/–≥—Ä—É–ø–ø—ã/—á–∞—Ç–∞, –∫—É–¥–∞ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è. –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –æ–±–ª–∞–¥–∞—Ç—å –ø—Ä–∞–≤–∞–º–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞, —á—Ç–æ–±—ã –≤—Å—ë —Ä–∞–±–æ—Ç–∞–ª–æ. –ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å ID –∫–∞–Ω–∞–ª–∞, –Ω–∞–ø–∏—à–∏—Ç–µ —Ç–∞–º –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∑–∞—Ç–µ–º —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –Ω–∞ –Ω–µ–≥–æ —Å—Å—ã–ª–∫—É –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é. –≠—Ç–æ –±—É–¥–µ—Ç —Å—Å—ã–ª–∫–∞ –≤–∏–¥–∞ [https://t.me/c/123459678/1](https://t.me/c/123459678/1)

–î–æ–±–∞–≤—å—Ç–µ —Å–ª–µ–≤–∞ -100 –∫ –±–æ–ª—å—à–æ–º—É —á–∏—Å–ª—É –≤ —Å—Å—ã–ª–∫–µ, —ç—Ç–æ –∏ –±—É–¥–µ—Ç ID –∫–∞–Ω–∞–ª–∞. –î–ª—è –ø—Ä–∏–º–µ—Ä–∞ —ç—Ç–æ `-100123459678`.

–ü–æ–ª–µ **–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** –∑–∞–¥–∞—ë—Ç –∫–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏, –æ–ø—Ä–µ–¥–µ–ª—è—é—â–µ–π –∏—Ç–æ–≥–æ–≤—ã–π –≤–∏–¥ –æ–ø–æ–≤–µ—â–µ–Ω–∏–π –≤ Telegram. –í–ø–∏—à–∏—Ç–µ —Ç—É–¥–∞ —Å–ª–µ–¥—É—é—â–∏–π –∫–æ–¥:

```javascript
const formatDateTime = (pubDate) => {
  const [date, timeZ] = new Date(Date.parse(pubDate || new Date()))
    .toISOString()
    .split(/T/);
  const [y, m, d] = date.split(/-/);
  const [time] = timeZ.split(/\./);

  return `${d}.${m}.${y} ${time} MSK`;
};

const formatTitle = (record) => {
  let icon = 'üêù';

  switch (record.topic) {
    case 'events':
      icon = 'üìÖ';

      break;
    case 'recomm':
      icon = 'üëç';

      break;
    case 'recDowngrade':
      icon = '‚¨áÔ∏è';

      break;
    case 'recUpgrade':
      icon = '‚¨ÜÔ∏è';

      break;
    case 'periodicals':
      icon = 'üì∞';

      break;
    case 'options':
      icon = 'üÖæÔ∏è';

      break;
    case 'general_news':
      icon = 'üåé';

      break;
    case 'hot_stocks':
      icon = 'üî•';

      break;
    case 'earnings':
      icon = 'üí∞';

      break;
    case 'syndic':
      break;
    case 'technical_analysis':
      icon = 'üíπ';

      break;
  }

  if (record.priority) icon = '‚ÄºÔ∏è' + icon;

  if (record.tickers.trim())
    return (
      icon +
      ' ' +
      record.tickers
        .split(',')
        .map((ticker) => {
          if (ticker.startsWith('$')) return ticker;

          return '$' + ticker;
        })
        .join(' ')
    );

  return icon + ' The Fly';
};

const options = {
  disable_web_page_preview: true
};

if (record.tickers.trim()) {
  options.reply_markup = JSON.stringify({
    inline_keyboard: [
      record.tickers
        .split(',')
        .filter((ticker) => {
          return ticker !== '$ECON';
        })
        .slice(0, 5)
        .map((t) => {
          if (t === 'SPB') t = 'SPB@US';

          return {
            text: t,
            callback_data: JSON.stringify({
              e: 'ticker',
              t
            })
          };
        })
    ]
  });
}

return {
  text: `${formatTitle(record)}
‚è∞ ${formatDateTime(record.date)}
<b><a href="${encodeURIComponent(record.link)}">${encodeURIComponent(
    record.title
  )}</a></b>`,
  options
};
```

&#x20;–í –ø—Ä–∏–º–µ—Ä–µ –ø–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ —Ä–∞–∑–º–µ—â–∞—é—Ç—Å—è –∫–Ω–æ–ø–∫–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ. –ß—Ç–æ–±—ã –æ–Ω–∏ —Ä–∞–±–æ—Ç–∞–ª–∏, –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –±–æ—Ç–∞ [–ø–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏](../recipes/webhook-for-tg-buttons.md).

–¢–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ —Å–µ—Ä–≤–∏—Å, **–ø–æ—Å–ª–µ —á–µ–≥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ**.
